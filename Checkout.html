<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout</title>

  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Courgette&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Viga&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="../Codes/style.css"/>

  <style>
     .checkout-wrapper {
      max-width: 900px;
      margin: 100px auto;
      padding: 20px;
      background-color: #ececec;
    }

    .checkout-section {
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 20px;
    }

    .form-row > div {
      flex: 1;
    }

    input[type="text"],
    input[type="number"] {
      width: 80%;
      padding: 8px;
      font-family: 'Poppins', sans-serif;
      margin-top: 8px;
      border: 1px solid #ccc;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .delivery-info {
      display: none;
      margin-top: 15px;
    }

    select {
      padding: 8px;
      width: 100%;
      font-family: 'Poppins', sans-serif;
    }

    table {
      width: 100%;
      margin-top: 20px;
      background-color: white;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }

    .checkout-btn {
      padding: 10px 25px;
      background-color: #10b658;
      color: white;
      border: none;
      border-radius: 6px;
      font-family: 'Viga', sans-serif;
      font-size: 15px;
      cursor: pointer;
    }

    .checkout-btn:hover {
      background-color: #299761;
    }

    /* Making all the inputs in delivery same size*/
    #delivery-fields input,
    #delivery-fields select {
  width: 100%;
  box-sizing: border-box;
}

  </style>
</head>
<body>
    <header style="margin-top: -100px;">
        <img src="../Assets/Print-Xbanner.png" alt="Logo" style="height: 60px;margin-left: 15%;" />
        <ul>
          <li><a href="../Codes/Print-X.html">Products</a></li>
          <li><a href="../Codes/AboutUs.html">About Us</a></li>
          <li class="cart-dropdown">
            <a href="../Codes/Cart.html">
              <img src="https://cdn-icons-png.flaticon.com/512/107/107831.png" class="cart-icon" />
            </a>
            <ul class="dropdown-menu">
              <li><a href="../Codes/ViewInvoice.html">View Invoice</a></li>
              <li><a href="../Codes/Cart.html">View Cart</a></li>
              <li><a href="../Codes/Checkout.html">Checkout</a></li>
            </ul>
          </li>
          <li><a id="loginstatus" href="../Codes/Login.html"><button class="button1">Login</button></a></li>
        </ul>
      </header>

      <div class="checkout-wrapper" id="checkout-section">
        <!-- Shows html base don script-->
      </div>

      <script>
        // Get the logged-in user and the cart items from localStorage
        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        const cart = JSON.parse(localStorage.getItem("cartItems")) || [];
      
        // Get the id of the div where checkout content will go
        const wrapper = document.getElementById("checkout-section");
      
        // Showing a message if the user is not logged in or the cart is empty
        if (!user || cart.length === 0) {
          wrapper.innerHTML = "<p>No product/s to checkout. Login or add products to cart</p>";
        } else {
          // Price list for each product and their minimums
          const productPrices = {
            "Business Cards": { price: 2200, minimum: 50 },
            "Programmes": { price: 7500, minimum: 50 },
            "Flyers/Posters": { price: 1500, minimum: 10 },
            "Labels & Stickers": { price: 2100, minimum: 100 },
            "Tickets": { price: 4500, minimum: 100 },
            "Receipt Books": { price: 16000, minimum: 2 },
            "Custom T-Shirts": { price: 2600, minimum: 3 },
            "Buttons": { price: 1000, minimum: 10 },
            "Vinyls": { price: 2800, minimum: 1 },
            "Banners": { price: 3000, minimum: 1 },
            "Stamps & Seals": { price: 4000, minimum: 1 },
            "Signs": { price: 6100, minimum: 1 }
          };
      
          // Calculate subtotal by looping through each cart item
          let subtotal = 0;
          cart.forEach(item => {
            const { price, minimum } = productPrices[item.productName];
            const unitPrice = price / minimum;
            subtotal += unitPrice * item.quantity;
          });
      
          // Caculating tax and total
          const tax = subtotal * 0.15;
          const total = subtotal + tax;
      
          // Display checkout form with customer name, payment info, order method and order summary
          wrapper.innerHTML = `
            <div class="checkout-section">
              <h2>Checkout</h2>
              <p><b>Enter card information for <u style="font-size:20px;">${user.name}</u></b></p>
            </div>
      
            <form id="checkout-form" class="checkout-section">
              <h3>Payment Information</h3>
              <div class="form-row">
                <div>
                  <label for="cardName">Name on Card</label>
                  <input type="text" id="cardName" required />
                </div>
                <div>
                  <label for="cardNumber">Card Number</label>
                  <input type="number" id="cardNumber" required />
                </div>
              </div>
      
              <div class="form-row">
                <div>
                  <label for="expiryMonth">Expiry Month</label>
                  <input type="number" id="expiryMonth" placeholder="MM" required min="1" max="12" />
                </div>
                <div>
                  <label for="expiryYear">Expiry Year</label>
                  <input type="number" id="expiryYear" placeholder="YYYY" required />
                </div>
                <div>
                  <label for="cvv">Security Number</label>
                  <input type="number" id="cvv" placeholder="CVV" required />
                </div>
              </div>
      
              <div class="checkout-section">
                <h3>Order Method</h3>
                <div class="radio-group">
                  <label><input type="radio" name="method" value="pickup" required onchange="toggleDelivery()"> Pickup (Ready 4 days after)</label>
                  <label><input type="radio" name="method" value="delivery" required onchange="toggleDelivery()"> Delivery</label>
                </div>
                <div class="delivery-info" id="delivery-fields" style="display: none;">
                  <input type="text" placeholder="Address Line 1" required />
                  <input type="text" placeholder="Address Line 2" />
                  <input type="text" placeholder="City" required />
                  <select required>
                    <option value="">Select Parish</option>
                    <option>Kingston</option>
                    <option>St. Andrew</option>
                    <option>St. Catherine</option>
                    <option>Clarendon</option>
                    <option>Manchester</option>
                    <option>St. Elizabeth</option>
                    <option>Westmoreland</option>
                    <option>Hanover</option>
                    <option>St. James</option>
                    <option>Trelawny</option>
                    <option>St. Ann</option>
                    <option>St. Mary</option>
                    <option>Portland</option>
                    <option>St. Thomas</option>
                  </select>
                </div>
              </div>
      
              <h3>Order Summary</h3>
              <table>
                <tr><th>Product</th><th>Quantity</th></tr>
                ${cart.map(item => `<tr><td>${item.productName}</td><td>${item.quantity}</td></tr>`).join("")}
              </table>
      
              <p style="font-size: 25px; margin-top: 10px;"><b>Total:</b> $${total.toFixed(2)}</p>
              <button class="checkout-btn" type="submit">Confirm and Pay</button>
            </form>
          `;
        }
      
        // This shows/hides delivery info based on selected method
        function toggleDelivery() {
          const delivery = document.getElementById("delivery-fields");
          const selected = document.querySelector('input[name="method"]:checked');
          if (selected && selected.value === "delivery") {
            delivery.style.display = "block";
          } else {
            delivery.style.display = "none";
          }
        }
      
        // Ensuring the correct number of digits are entered ofr each part in payment info else it displays a message
        document.addEventListener("submit", function (e) {
          const form = document.getElementById("checkout-form");
          if (form && e.target === form) {
            const month = document.getElementById("expiryMonth").value;
            const year = document.getElementById("expiryYear").value;
            const cvv = document.getElementById("cvv").value;
      
            if (month.length !== 2 || +month < 1 || +month > 12) {
              alert("Enter a valid 2-digit month (01â€“12).");
              e.preventDefault();
              return;
            }
      
            if (year.length !== 4) {
              alert("Enter a 4-digit year.");
              e.preventDefault();
              return;
            }
      
            if (cvv.length !== 3) {
              alert("Enter 3 digits CVV.");
              e.preventDefault();
              return;
            }
          }
        });
      </script>
    
     <script>
        //Checks if the user is logged in
        const loginStatusBtn = document.getElementById("loginstatus");
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        
        // If user is logged in show the optioon to log out
        if (loggedInUser) {
        loginStatusBtn.textContent = "Log Out";
        loginStatusBtn.href = "#";
        loginStatusBtn.className = "button1";
        loginStatusBtn.addEventListener("click", function (e) {
            e.preventDefault(); // Stop link from reloading
            localStorage.removeItem("loggedInUser");
            location.reload();
        });

        } else {
            // If not logged in show the Login option
            loginStatusBtn.textContent = "Login";
            loginStatusBtn.className = "button1";
            loginStatusBtn.href = "../Codes/Login.html";
        }
        </script>   
      
</body>
</html>
